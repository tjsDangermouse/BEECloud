<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - MELCloud Dashboard</title>
    <link rel="icon" type="image/png" href="/static/Beelogo.png">
    <link rel="shortcut icon" type="image/png" href="/static/Beelogo.png">
    <link rel="stylesheet" href="/static/css/tailwind.css" onerror="(function(){var s=document.createElement('script');s.src='https://cdn.tailwindcss.com';document.head.appendChild(s)})()">
    <script defer src="/static/js/sw-register.js"></script>
    <script>
        if (typeof tailwind !== 'undefined') { tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        } }
    </script>
</head>
<body class="h-full bg-gray-800 dark:bg-gray-900 font-sans leading-relaxed text-gray-900 dark:text-gray-100 transition-colors duration-200">
    <div class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="bg-white dark:bg-gray-900 rounded-lg shadow-xl max-w-md w-full space-y-8 p-8">
            <div>
                <div class="mx-auto h-20 w-20 flex items-center justify-center">
                    <img class="w-20 h-14" src="/static/Beelogo.png" alt="MELCloud Dashboard" onerror="this.style.display='none'">
                </div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900 dark:text-gray-100">
                    Sign in to MELCloud Dashboard
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">
                    Access your heat pump monitoring system
                </p>
            </div>
            
            <!-- Flash Messages -->
            <div id="flash-messages" class="space-y-2"></div>
            
            <form class="mt-8 space-y-6" id="loginForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="username" class="sr-only">Username or Email</label>
                        <input id="username" name="username" type="text" required 
                               class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-gray-100 rounded-t-md focus:outline-none focus:ring-primary-500 focus:border-primary-500 focus:z-10 sm:text-sm bg-white dark:bg-gray-700" 
                               placeholder="Username or Email">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" required 
                               class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-gray-100 rounded-b-md focus:outline-none focus:ring-primary-500 focus:border-primary-500 focus:z-10 sm:text-sm bg-white dark:bg-gray-700" 
                               placeholder="Password">
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember_me" name="remember_me" type="checkbox" 
                               class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                        <label for="remember_me" class="ml-2 block text-sm text-gray-900 dark:text-gray-100">
                            Remember me
                        </label>
                    </div>
                </div>

                <div>
                    <button type="submit" id="loginButton"
                            class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                            <svg class="h-5 w-5 text-primary-500 group-hover:text-primary-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        <span id="loginButtonText">Sign in</span>
                    </button>
                </div>

                <div class="text-center">
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        Secure access to your MELCloud data
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Flash message handling - uses dedicated flash-messages container
        function showFlash(message, type = 'info') {
            console.log('showFlash called:', message, type); // Debug log
            
            // Get the designated flash messages container
            const container = document.getElementById('flash-messages');
            if (!container) {
                console.error('Flash messages container not found!');
                return;
            }
            
            // Clear any existing messages
            container.innerHTML = '';
            
            // Create the flash message element
            const flash = document.createElement('div');
            flash.textContent = message;
            
            // Use Tailwind classes that should be available on login page
            let classes = 'px-4 py-3 rounded-md mb-2 text-sm font-medium ';
            if (type === 'success') {
                classes += 'bg-green-50 dark:bg-green-900/50 text-green-800 dark:text-green-200 border border-green-200 dark:border-green-700';
            } else if (type === 'error') {
                classes += 'bg-red-50 dark:bg-red-900/50 text-red-800 dark:text-red-200 border border-red-200 dark:border-red-700';
            } else {
                classes += 'bg-blue-50 dark:bg-blue-900/50 text-blue-800 dark:text-blue-200 border border-blue-200 dark:border-blue-700';
            }
            
            flash.className = classes;
            
            // Start hidden for animation
            flash.style.opacity = '0';
            flash.style.transform = 'translateY(-10px)';
            flash.style.transition = 'all 0.3s ease';
            
            container.appendChild(flash);
            
            // Animate in
            setTimeout(() => {
                flash.style.opacity = '1';
                flash.style.transform = 'translateY(0)';
            }, 50);
            
            // Auto-fade after 3 seconds (but don't remove for success messages until redirect)
            if (type !== 'success') {
                setTimeout(() => {
                    flash.style.opacity = '0.7';
                }, 3000);
            }
        }

        // Login form handling
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const button = document.getElementById('loginButton');
            const buttonText = document.getElementById('loginButtonText');
            const originalText = buttonText.textContent;
            
            // Show loading state
            button.disabled = true;
            buttonText.textContent = 'Signing in...';
            
            try {
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showFlash(result.message || 'Login successful!', 'success');
                    
                    // Redirect after delay to show the success message
                    setTimeout(() => {
                        window.location.href = result.redirect || '/dashboard';
                    }, 2500);
                } else {
                    showFlash(result.error || 'Login failed', 'error');
                    
                    // Reset form state
                    button.disabled = false;
                    buttonText.textContent = originalText;
                    
                    // Clear password field on error
                    document.getElementById('password').value = '';
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showFlash('Network error. Please check your connection and try again.', 'error');
                
                // Reset form state
                button.disabled = false;
                buttonText.textContent = originalText;
            }
        });

        // Dark mode initialization (sync with main site)
        function initializeDarkMode() {
            const darkModePreference = localStorage.getItem('darkMode') || 'false';
            const html = document.documentElement;
            
            if (darkModePreference === 'true') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
        }

        // Focus on username field on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeDarkMode();
            document.getElementById('username').focus();
        });

        // Enter key handling
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const form = document.getElementById('loginForm');
                if (form && !document.getElementById('loginButton').disabled) {
                    form.requestSubmit();
                }
            }
        });
    </script>
</body>
</html>
